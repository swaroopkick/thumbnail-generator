# Image Export Pipeline

## Overview

The image export pipeline is a comprehensive system for post-processing images generated by the Gemini API. It handles:

1. **Decoding** - Convert image data to PIL Image objects
2. **Normalization** - Convert to RGB and resize to target dimensions
3. **Compositing** - Blend generated images with uploaded base images
4. **Multi-format Export** - Generate PNG, JPEG, and WebP variants
5. **URL Management** - Serve files via static routes or signed URLs
6. **Cleanup** - Periodically remove old temporary and output files

## Architecture

### Components

#### ImageExportService
Located in `backend/app/services/image_export_service.py`

The main service responsible for image processing and export. Key methods:

- `process_and_export_image()` - Main entry point for processing
- `_normalize_image()` - Convert to RGB and resize
- `_composite_images()` - Blend with base image
- `_export_formats()` - Generate PNG, JPEG, WebP
- `_generate_url()` - Create download URLs
- `cleanup_temp_files()` - Remove old temporary files
- `cleanup_output_files()` - Remove old exported files

#### Configuration
Located in `backend/app/config.py`

Settings for:
- Output and temporary directories
- Image quality and compression settings
- URL signing options
- Gemini API configuration

#### Gemini Service
Modified in `backend/app/services/gemini_service.py`

Integrated with ImageExportService to automatically process generated images.

## Usage

### Basic Image Processing

```python
from backend.app.services.image_export_service import ImageExportService

service = ImageExportService()

# Process image from bytes
exports = service.process_and_export_image(
    image_data=image_bytes,
    base_image_path="/path/to/base.png",  # Optional
    normalize_dimensions=(1920, 1080),     # Optional
    metadata={"source": "gemini"}
)

# Returns:
# {
#     "png": {
#         "format": "PNG",
#         "url": "/static/output/export_123.png",
#         "file_path": "/full/path/to/export_123.png",
#         "size": 12345,
#         "exported_at": "2024-01-15T10:30:45.123456"
#     },
#     "jpeg": {...},
#     "webp": {...}
# }
```

### Via API

```bash
curl -X POST http://localhost:8000/api/thumbnails \
  -F "script=My awesome video" \
  -F "image=@my_image.png" \
  -F "aspect_ratio=16:9" \
  -F "count=2"
```

Response includes exports for each format:

```json
{
  "request_id": "req_abc123",
  "variations": [
    {
      "id": "var-1",
      "storage_path": "/path/to/raw.png",
      "metadata": {...},
      "exports": {
        "png": {
          "format": "PNG",
          "url": "/static/output/export_123.png",
          "file_path": "...",
          "size": 12345,
          "exported_at": "2024-01-15T10:30:45.123456"
        },
        "jpeg": {...},
        "webp": {...}
      }
    }
  ]
}
```

## Image Format Details

### PNG
- **Format**: PNG (Portable Network Graphics)
- **Characteristics**: Lossless compression, supports transparency
- **Use Case**: Best for high-quality images with transparency needs
- **Quality Setting**: `PNG_COMPRESSION` (0-9, default: 9)
- **Typical Size**: Larger due to lossless compression

### JPEG
- **Format**: JPEG (Joint Photographic Experts Group)
- **Characteristics**: Lossy compression, no transparency
- **Use Case**: Best for photos and thumbnails, smaller file size
- **Quality Setting**: `JPEG_QUALITY` (0-100, default: 85)
- **Typical Size**: Small, good compression ratio

### WebP
- **Format**: WebP (modern image format by Google)
- **Characteristics**: Better compression than JPEG, supports transparency
- **Use Case**: Modern web applications, better quality/size ratio than JPEG
- **Quality Setting**: `WEBP_QUALITY` (0-100, default: 80)
- **Typical Size**: Generally smaller than JPEG at same quality

## Image Compositing

When a base image is provided, the generated image is composited with it:

```python
exports = service.process_and_export_image(
    image_data=gemini_generated_bytes,
    base_image_path="/path/to/uploaded_base.png"
)
```

The compositing process:
1. Loads the base image
2. Normalizes both images to the same size
3. Blends them (70% generated, 30% base)
4. Exports the composited result

If base image loading fails, the generated image alone is exported.

## URL Management

### Static Files (Default)

When `SIGN_URLS=false`:
- Files are served via FastAPI StaticFiles
- URLs: `/static/output/export_123.png`
- No expiry
- Suitable for permanent or semi-permanent content

### Signed URLs

When `SIGN_URLS=true`:
- URLs include HMAC-SHA256 signature and expiry timestamp
- URLs: `/api/download/export_123.png?expires=1234567890&signature=abc...`
- Signature verification on download
- Configurable expiry time

To enable signed URLs:

```env
SIGN_URLS=true
SIGNING_SECRET=your-secure-secret-key
URL_SIGNATURE_EXPIRY=3600
```

## Cleanup

The system provides automatic cleanup for old files:

### Manual Cleanup

```python
from backend.app.utils.cleanup import cleanup_old_files

result = cleanup_old_files()
# Returns: {"temp_files_deleted": 5, "output_files_deleted": 2}
```

### Automatic Cleanup Scheduling

For production, set up a background task or cron job:

```bash
# Cron job - run daily
0 2 * * * cd /path/to/app && python -c "from backend.app.utils.cleanup import cleanup_old_files; cleanup_old_files()"
```

Cleanup Configuration:
- Temp files: Removed after 1 day
- Output files: Removed after 7 days

Change thresholds in the cleanup call or config:

```python
export_service.cleanup_temp_files(days=2)
export_service.cleanup_output_files(days=14)
```

## Directory Structure

```
backend/storage/
├── uploads/           # User-uploaded base images
├── generated/         # Raw generated images from Gemini
├── output/            # Processed exports (PNG, JPEG, WebP)
└── temp/              # Temporary files (cleaned up regularly)
```

## Performance Considerations

### Quality vs File Size

For typical thumbnails (1280x720):
- PNG at compression 9: ~100-200 KB
- JPEG at quality 85: ~30-50 KB
- WebP at quality 80: ~25-40 KB

Adjust settings based on your requirements:

```env
# Higher quality, larger files
JPEG_QUALITY=95
WEBP_QUALITY=90

# Lower quality, smaller files
JPEG_QUALITY=75
WEBP_QUALITY=70
```

### Memory Usage

Image processing loads the entire image into memory. For large images:
- Consider normalizing dimensions to reasonable sizes
- Monitor memory usage with large batch counts
- Use `MAX_VARIATIONS` to limit concurrent processing

### Storage

With default settings and 7-day cleanup:
- Each variation: ~100-200 KB (3 formats)
- 100 variations/day: ~10-20 MB
- Weekly storage: ~70-140 MB

## Error Handling

The pipeline includes robust error handling:

1. **Image Loading Fails**: Falls back to returned image
2. **Compositing Fails**: Returns generated image only
3. **Format Export Fails**: Logs error, skips format
4. **URL Generation Fails**: Returns static path or signed URL

All errors are logged with context for debugging.

## Testing

Comprehensive tests are provided:

```bash
# Test image export functionality
pytest backend/tests/test_image_export.py -v

# Test endpoints with exports
pytest backend/tests/test_endpoints_with_exports.py -v

# Run all tests
pytest backend/tests/ -v
```

Key test coverage:
- Image normalization (RGB conversion, resizing)
- Format exports (PNG, JPEG, WebP)
- Compositing with base images
- URL generation (static and signed)
- Cleanup operations
- Configuration loading

## Integration with Gemini Service

The `GeminiService` automatically processes generated images:

```python
class GeminiService:
    def __init__(self):
        self.export_service = ImageExportService()
    
    def generate_thumbnails(self, script, image_path, aspect_ratio, count=1):
        # ... generate image via Gemini API ...
        
        # Process and export
        exports = self.export_service.process_and_export_image(
            image_data=image_data,
            base_image_path=image_path,
            metadata={"prompt": prompt, "model": self.model_name}
        )
        
        return ThumbnailVariation(
            id=variation_id,
            storage_path=saved_path,
            exports=self._format_exports(exports)
        )
```

## Troubleshooting

### Exported files not found
- Check `OUTPUT_DIR` configuration
- Verify directory permissions
- Check disk space availability

### Images not compositing correctly
- Ensure base image path is valid
- Check image format compatibility (JPEG, PNG, WebP)
- Check available memory for large images

### URL signing failures
- Verify `SIGNING_SECRET` is set consistently
- Check that `URL_SIGNATURE_EXPIRY` is reasonable
- Ensure server time is synchronized

### Large file sizes
- Reduce `JPEG_QUALITY` or `WEBP_QUALITY`
- Reduce output image dimensions
- Use WebP format (better compression than JPEG)

### Memory issues with large batches
- Reduce `MAX_VARIATIONS`
- Reduce output image dimensions
- Process in smaller batches

## Future Enhancements

Potential improvements:
- Async image processing for better performance
- Cloud storage integration (S3, GCS, etc.)
- Image optimization libraries (libvips, ImageMagick)
- Progressive JPEG encoding
- Animated GIF support
- Batch processing API
- Scheduled cleanup tasks via APScheduler
